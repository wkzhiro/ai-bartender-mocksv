# UUIDå¯¾å¿œãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å ±å‘Š

## ğŸ“‹ æ¦‚è¦

ai-bartender-mocksvã‚·ã‚¹ãƒ†ãƒ ã«ãŠã„ã¦ã€ã‚«ã‚¯ãƒ†ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã®IDã‚’SERIALï¼ˆæ•´æ•°ï¼‰ã‹ã‚‰UUIDãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ã«å¤‰æ›ã—ã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚‚UUID.pngå½¢å¼ã«çµ±ä¸€ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚

## ğŸ¯ å®Ÿæ–½ç›®çš„

- **ä¸€æ„æ€§ã®å‘ä¸Š**: UUIDã«ã‚ˆã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè­˜åˆ¥å­
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: æ¨æ¸¬å›°é›£ãªIDã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢
- **åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œ**: å°†æ¥ã®åˆ†æ•£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ã®æº–å‚™
- **ç”»åƒç®¡ç†çµ±ä¸€**: ãƒ•ã‚¡ã‚¤ãƒ«åã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã®æ•´åˆæ€§ç¢ºä¿

## ğŸ”§ æŠ€è¡“çš„å¤‰æ›´å†…å®¹

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ å¤‰æ›´

#### Before (å¤‰æ›´å‰)
```sql
CREATE TABLE cocktails (
    id SERIAL PRIMARY KEY,           -- æ•´æ•°ID
    order_id VARCHAR(32) UNIQUE,
    -- ãã®ä»–ã®ã‚«ãƒ©ãƒ 
);
```

#### After (å¤‰æ›´å¾Œ)
```sql
CREATE TABLE cocktails (
    uuid UUID PRIMARY KEY DEFAULT gen_random_uuid(),  -- UUIDãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼
    order_id VARCHAR(32) UNIQUE,
    -- ãã®ä»–ã®ã‚«ãƒ©ãƒ 
);
```

### 2. é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼æ›´æ–°

- `survey_responses.cocktail_id`: INTEGER â†’ UUID
- `cocktail_prompts.cocktail_id`: INTEGER â†’ UUID  
- `violation_reports.cocktail_id`: INTEGER â†’ UUID

### 3. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡å¤‰æ›´

#### Before
```
/storage/cocktail-images/cocktails/457873.png
```

#### After
```
/storage/cocktail-images/cocktails/aeb35983-d198-4b1b-9f22-cd8db38efb3e.png
```

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£
- `migration/20250821_02_add_uuid_column.sql`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ å¤‰æ›´SQL
- `migration/migrate_images_to_uuid.py`: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `migration/uuid_mapping.csv`: order_id â†” UUID ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨

### ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
- `db/supabase_client.py`: UUIDå¯¾å¿œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `services/cocktail_service.py`: UUIDç”Ÿæˆãƒ»æŒ¿å…¥å¯¾å¿œ
- `utils/image_utils.py`: UUIDå½¢å¼ç”»åƒç®¡ç†
- `main.py`: ã‚«ã‚¯ãƒ†ãƒ«ä¸€è¦§APIä¿®æ­£
- `routers/cocktails.py`: å€‹åˆ¥ã‚«ã‚¯ãƒ†ãƒ«APIä¿®æ­£

## ğŸš€ å®Ÿè¡Œæ‰‹é †

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```sql
-- Supabase Dashboard â†’ SQL Editor ã§å®Ÿè¡Œ
-- migration/20250821_02_add_uuid_column.sql
```

### 2. ç”»åƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```bash
cd /path/to/ai-bartender-mocksv
python migration/migrate_images_to_uuid.py -y
```

## ğŸ“Š ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- âœ… å…¨ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ å¤‰æ›´å®Œäº†
- âœ… å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å†è¨­å®šå®Œäº†
- âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿UUIDå‰²ã‚Šå½“ã¦å®Œäº†

### ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
- ç·ã‚«ã‚¯ãƒ†ãƒ«æ•°: **46ä»¶**
- UUIDå½¢å¼ç§»è¡Œæ¸ˆã¿: **16ä»¶** (35%)
- ç§»è¡Œå¯¾è±¡å¤–: **30ä»¶** (65% - ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æœªå­˜åœ¨)

## ğŸ”„ APIäº’æ›æ€§

### å¤–éƒ¨APIäº’æ›æ€§ç¶­æŒ
```python
# æ—¢å­˜APIã¯å¼•ãç¶šãorder_idã§å‹•ä½œ
GET /order/?order_id=457873  # âœ… å‹•ä½œç¶™ç¶š

# å†…éƒ¨çš„ã«UUIDã«å¤‰æ›ã—ã¦å‡¦ç†
def get_cocktail_by_order_id(order_id: str):
    uuid = get_uuid_from_order_id(order_id)  # å†…éƒ¨å¤‰æ›
    return get_cocktail_by_uuid(uuid)
```

### æ–°æ©Ÿèƒ½
```python
# UUIDç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ©Ÿèƒ½è¿½åŠ 
def get_cocktail_by_uuid(cocktail_uuid: str):
    return supabase_client.get_cocktail_by_uuid(cocktail_uuid)

# UUID â†” order_id ç›¸äº’å¤‰æ›
uuid_val = get_uuid_from_order_id("457873")
order_id = get_order_id_from_uuid("aeb35983-d198-4b1b-9f22-cd8db38efb3e")
```

## ğŸ›¡ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

### ç”»åƒå–å¾—ã®å¤šæ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
1. **UUIDå½¢å¼ã§å–å¾—è©¦è¡Œ** (æœ€å„ªå…ˆ)
   ```
   GET /storage/cocktails/{uuid}.png
   ```
2. **order_idå½¢å¼ã§å–å¾—è©¦è¡Œ** (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
   ```
   GET /storage/cocktails/{order_id}.png
   ```
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°** (æœ€çµ‚æ‰‹æ®µ)
   ```
   404 Not Found ã¾ãŸã¯ç©ºã®base64æ–‡å­—åˆ—
   ```

## ğŸ§ª å‹•ä½œç¢ºèª

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œãƒ†ã‚¹ãƒˆ
```python
# UUID â†” order_id å¤‰æ›ãƒ†ã‚¹ãƒˆ
order_id = "238221"
uuid_from_order = get_uuid_from_order_id(order_id)
order_from_uuid = get_order_id_from_uuid(uuid_from_order)
assert order_id == order_from_uuid  # âœ… PASS

# ç”»åƒURLå–å¾—ãƒ†ã‚¹ãƒˆ
uuid_url = get_image_url_by_uuid(uuid_from_order)
order_url = get_image_url_by_order_id(order_id)
assert uuid_url == order_url  # âœ… PASS
```

### ã‚«ã‚¯ãƒ†ãƒ«ä¸€è¦§è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
```python
# ã‚«ã‚¯ãƒ†ãƒ«ä¸€è¦§å–å¾—ï¼ˆç”»åƒè¡¨ç¤ºç¢ºèªï¼‰
cocktails = get_all_cocktails(limit=5)
for cocktail in cocktails['data']:
    print(f"Name: {cocktail['name']}")
    print(f"UUID: {cocktail['uuid']}")
    print(f"Image: {'âœ… Found' if cocktail['image_base64'] else 'âŒ Not Found'}")
```

## ğŸš¨ æ³¨æ„äº‹é …ãƒ»åˆ¶é™äº‹é …

### ç§»è¡ŒæœŸé–“ã®è€ƒæ…®äº‹é …
- **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿**: ç”»åƒãŒãªã„30ä»¶ã®ã‚«ã‚¯ãƒ†ãƒ«ã¯è¡¨ç¤ºä¸Šå•é¡Œãªã—ï¼ˆç©ºã®ç”»åƒã¨ã—ã¦å‡¦ç†ï¼‰
- **æ–°è¦ä½œæˆ**: 2025å¹´8æœˆ21æ—¥ä»¥é™ä½œæˆã•ã‚Œã‚‹ã‚«ã‚¯ãƒ†ãƒ«ã¯å…¨ã¦UUID.pngå½¢å¼
- **APIäº’æ›æ€§**: æ—¢å­˜ã®order_idåŸºç›¤APIã¯å¼•ãç¶šãå‹•ä½œ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: UUIDä¸»ã‚­ãƒ¼ã«ã‚ˆã‚‹è‹¥å¹²ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ï¼ˆå¾®å°ï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´ã«ã‚ˆã‚‹é‡è¤‡ãªã—ï¼ˆç§»è¡Œæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
- **API**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«ã‚ˆã‚‹1-2å›ã®è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰

## ğŸ”® ä»Šå¾Œã®å±•æœ›

### å®Œå…¨ç§»è¡Œã¸ã®é“ç­‹
1. **æ®‹ã‚Šã®ç”»åƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: å¿…è¦ã«å¿œã˜ã¦æ®‹ã‚Š30ä»¶ã®ç”»åƒä½œæˆãƒ»ç§»è¡Œ
2. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å‰Šé™¤**: ç§»è¡Œå®Œäº†å¾Œã€order_idå½¢å¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: UUIDå°‚ç”¨ã®æœ€é©åŒ–å®Ÿè£…

### æ–°æ©Ÿèƒ½å¯èƒ½æ€§
- **åˆ†æ•£IDç”Ÿæˆ**: è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã§ã®ä¸€æ„IDç”Ÿæˆ
- **ã‚¯ãƒ­ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§**: UUIDçµ±ä¸€ã«ã‚ˆã‚‹æ¨ªæ–­æ¤œç´¢æ©Ÿèƒ½
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: æ¨æ¸¬å›°é›£IDã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

## ğŸ“ ã‚µãƒãƒ¼ãƒˆãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

**Q: ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“**
```
A: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
1. ã‚«ã‚¯ãƒ†ãƒ«ã«UUIDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. å¯¾å¿œã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹
3. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§ã©ã®å½¢å¼ã§å–å¾—ã‚’è©¦è¡Œã—ã¦ã„ã‚‹ã‹
```

**Q: å¤ã„order_idã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“**
```
A: äº’æ›æ€§ã¯ç¶­æŒã•ã‚Œã¦ã„ã¾ã™ï¼š
1. get_uuid_from_order_id()é–¢æ•°ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèª
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šçŠ¶æ³ã‚’ç¢ºèª
3. Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®šã‚’ç¢ºèª
```

### ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰
```bash
# UUIDå¤‰æ›ãƒ†ã‚¹ãƒˆ
python -c "
from db import database as db
print(db.get_uuid_from_order_id('238221'))
print(db.get_order_id_from_uuid('b19bb156-780a-4283-84a5-1a73fc99cfdc'))
"

# ç”»åƒå–å¾—ãƒ†ã‚¹ãƒˆ
python -c "
from utils.image_utils import get_image_url_by_uuid
print(get_image_url_by_uuid('b19bb156-780a-4283-84a5-1a73fc99cfdc'))
"
```

---

## ğŸ“… å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´è€… | å¤‰æ›´å†…å®¹ |
|------|--------|----------|
| 2025-08-21 | Claude | UUIDå¯¾å¿œãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œå…¨å®Ÿè£… |
| 2025-08-21 | Claude | ç”»åƒè¡¨ç¤ºå•é¡Œä¿®æ­£ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£… |

---

**ğŸ“„ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
- [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°](migration/migration_history.md)
- [APIä»•æ§˜æ›¸](docs/api_specification.md)
- [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰](docs/troubleshooting.md)